<head>
  <meta charset="utf-8" />
  {{ with .Site.Language.Params.htmlCode | default .Site.LanguageCode }}
  <meta http-equiv="content-language" content="{{ . }}" />
  {{ end }}
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />

  <!-- Early Theme Init - prevents flash -->
  <script>
    (function() {
      const defaultTheme = document.documentElement.getAttribute('data-default-appearance') || 'light';
      const userPreference = localStorage.getItem('appearance');
      const autoSwitch = document.documentElement.getAttribute('data-auto-appearance') === 'true';
      
      // Apply theme based on saved preference or default
      if ((defaultTheme === 'dark' && !userPreference) || userPreference === 'dark') {
        document.documentElement.classList.add('dark');
      }

      // Handle system preference
      if (autoSwitch) {
        if (window.matchMedia && 
            window.matchMedia('(prefers-color-scheme: dark)').matches && 
            userPreference !== 'light') {
          document.documentElement.classList.add('dark');
        }
      }
    })();
  </script>

  <!-- Theme Switcher Script -->
  <script>
    function updateMeta() {
      const elem = document.querySelector('body');
      const style = getComputedStyle(elem);
      document.querySelector('meta[name="theme-color"]')?.setAttribute('content', style.backgroundColor);
    }

    function getTargetAppearance() {
      return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    }

    window.addEventListener('DOMContentLoaded', () => {
      const switcher = document.getElementById('appearance-switcher');
      const switcherMobile = document.getElementById('appearance-switcher-mobile');
      const autoSwitch = document.documentElement.getAttribute('data-auto-appearance') === 'true';

      // Update meta on load
      updateMeta();

      // Setup system preference change listener
      if (autoSwitch) {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (event) => {
          if (!localStorage.getItem('appearance')) {
            if (event.matches) {
              document.documentElement.classList.add('dark');
            } else {
              document.documentElement.classList.remove('dark');
            }
            updateMeta();
          }
        });
      }

      // Setup click handlers
      [switcher, switcherMobile].forEach(button => {
        if (button) {
          button.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            const targetAppearance = getTargetAppearance();
            localStorage.setItem('appearance', targetAppearance);
            updateMeta();
            
            // Update aria-pressed
            button.setAttribute('aria-pressed', targetAppearance === 'dark');
          });

          // Right click to reset to system preference
          button.addEventListener('contextmenu', (event) => {
            event.preventDefault();
            localStorage.removeItem('appearance');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.documentElement.classList.toggle('dark', prefersDark);
            updateMeta();
          });
        }
      });
    });
  </script>

  {{/* Title */}}
  {{ if .IsHome -}}
  <title>{{ .Site.Title | emojify }}</title>
  <meta name="title" content="{{ .Site.Title | emojify }}" />
  {{- else -}}
  <title>{{ .Title | emojify }} &middot; {{ .Site.Title | emojify }}</title>
  <meta name="title" content="{{ .Title | emojify }} &middot; {{ .Site.Title | emojify }}" />
  {{- end }}

  {{/* Metadata */}}
  {{ with (.Params.Summary | default .Params.Description) | default .Site.Params.description -}}
  <meta name="description" content="{{ . }}" />
  {{- end }}
  {{ with  .Params.Tags | default .Site.Params.keywords -}}
  <meta name="keywords" content="{{ range . }}{{ . }}, {{ end -}}" />
  {{- end }}
  {{ with .Site.Params.robots }}
  <meta name="robots" content="{{ . }}" />
  {{ end }}
  {{ with .Params.robots }}
  <meta name="robots" content="{{ . }}" />
  {{ end }}
  <link rel="canonical" href="{{ .Permalink }}" />
  {{ range .AlternativeOutputFormats -}}
  {{ printf `<link rel="%s" type="%s" href="%s" title="%s" />` .Rel .MediaType.Type .RelPermalink ($.Site.Title | emojify) | safeHTML }}
  {{ end -}}

  {{/* Asset bundles */}}
  {{ $assets := newScratch }}
  {{ $cssScheme := resources.Get (printf "css/schemes/%s.css" (.Site.Params.colorScheme | default "blowfish")) }}
  {{ if not $cssScheme }}
  {{ $cssScheme = resources.Get "css/schemes/blowfish.css" }}
  {{ end }}
  {{ $assets.Add "css" (slice $cssScheme) }}
  {{ $cssMain := resources.Get "css/compiled/main.css" }}
  {{ $assets.Add "css" (slice $cssMain) }}
  {{ $cssCustom := resources.Get "css/custom.css" }}
  {{ if $cssCustom }}
  {{ $assets.Add "css" (slice $cssCustom) }}
  {{ end }}
  {{ $bundleCSS := $assets.Get "css" | resources.Concat "css/main.bundle.css" | resources.Minify | resources.Fingerprint "sha512" }}
  <link type="text/css" rel="stylesheet" href="{{ $bundleCSS.RelPermalink }}" integrity="{{ $bundleCSS.Data.Integrity }}" />

  {{ if .Site.Params.enableSearch | default false }}
  {{ $jsFuse := resources.Get "lib/fuse/fuse.min.js" }}
  {{ $jsSearch := resources.Get "js/search.js" }}
  {{ $assets.Add "js" (slice $jsFuse $jsSearch) }}
  {{ end }}
  
  {{ if .Site.Params.enableCodeCopy | default false }}
  {{ $jsCode := resources.Get "js/code.js" }}
  {{ $assets.Add "js" (slice $jsCode) }}
  {{ end }}
  
  {{ if .Site.Params.rtl | default false }}
  {{ $jsRTL := resources.Get "js/rtl.js" }}
  {{ $assets.Add "js" (slice $jsRTL) }}
  {{ end }}

  {{ $jsMobileMenu := resources.Get "js/mobilemenu.js" }}
  {{ $assets.Add "js" (slice $jsMobileMenu) }}

  {{ if $assets.Get "js" }}
  {{ $bundleJS := $assets.Get "js" | resources.Concat "js/main.bundle.js" | resources.Minify | resources.Fingerprint "sha512" }}
  <script defer type="text/javascript" id="script-bundle" src="{{ $bundleJS.RelPermalink }}" integrity="{{ $bundleJS.Data.Integrity }}" data-copy="{{ i18n "code.copy" }}" data-copied="{{ i18n "code.copied" }}"></script>
  {{ end }}

  {{/* Icons */}}
  {{ if templates.Exists "partials/favicons.html" }}
  {{ partialCached "favicons.html" .Site }}
  {{ else }}
  <link rel="apple-touch-icon" sizes="180x180" href="{{ "apple-touch-icon.png" | relURL }}" />
  <link rel="icon" type="image/png" sizes="32x32" href="{{ "favicon-32x32.png" | relURL }}" />
  <link rel="icon" type="image/png" sizes="16x16" href="{{ "favicon-16x16.png" | relURL }}" />
  <link rel="manifest" href="{{ "site.webmanifest" | relURL }}" />
  {{ end }}

  {{/* Social */}}
  {{ template "_internal/opengraph.html" . }}
  {{ template "_internal/twitter_cards.html" . }}

  {{/* Schema */}}
  {{ partial "schema.html" . }}

  {{/* Me */}}
  {{ with .Site.Params.Author.name }}
  <meta name="author" content="{{ . }}" />{{ end }}
  {{ with .Site.Params.Author.links }}
  {{ range $links := . }}
  {{ range $name, $url := $links }}
  <link href="{{ $url }}" rel="me" />{{ end }}
  {{ end }}
  {{ end }}

  {{/* Analytics */}}
  {{ partial "analytics/main.html" .Site }}

  {{/* Extend head - eg. for custom analytics scripts, etc. */}}
  {{ if templates.Exists "partials/extend-head.html" }}
  {{ partialCached "extend-head.html" .Site }}
  {{ end }}

  <meta name="theme-color"/>
</head>